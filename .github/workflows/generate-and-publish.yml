# This workflow is triggered by the monorepo when the API spec changes.
# It fetches the public OpenAPI spec from the live API, generates the SDK, and creates a PR.
# Publishing happens separately via publish-release.yml after the PR is merged.
#
# SDK versioning is independent from API versioning:
# - SDK version: follows semver for the SDK itself (bug fixes, features, breaking changes)
# - apiVersion: tracks which API spec was used to generate the SDK (stored in package.json)

name: Generate SDK

on:
  # Triggered by repository_dispatch from the monorepo
  repository_dispatch:
    types: [update-sdk]

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - minor
          - patch
          - major
        default: 'minor'
      api_url:
        description: 'URL to fetch OpenAPI spec from'
        required: false
        type: string
        default: 'https://api.app-abby.com/api-docs/public.json'

jobs:
  generate:
    name: Generate SDK and Create PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Get parameters from event
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Triggered by monorepo - always bump minor for API changes
            BUMP="minor"
            API_URL="${{ github.event.client_payload.api_url }}"
            API_VERSION="${{ github.event.client_payload.version }}"
          else
            # Manual trigger
            BUMP="${{ inputs.bump }}"
            API_URL="${{ inputs.api_url }}"
            API_VERSION=""  # Will be extracted from spec
          fi

          # Default API URL if not provided
          if [ -z "$API_URL" ]; then
            API_URL="https://api.app-abby.com/api-docs/public.json"
          fi

          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "api_version_hint=$API_VERSION" >> $GITHUB_OUTPUT

          echo "Bump type: $BUMP"
          echo "API URL: $API_URL"

      - name: Fetch OpenAPI spec from API
        id: fetch_spec
        run: |
          echo "Fetching OpenAPI spec from ${{ steps.params.outputs.api_url }}..."

          HTTP_STATUS=$(curl -s -w "%{http_code}" -o public-openapi.json "${{ steps.params.outputs.api_url }}")

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: Failed to fetch OpenAPI spec (HTTP $HTTP_STATUS)"
            exit 1
          fi

          # Validate JSON
          if ! jq empty public-openapi.json 2>/dev/null; then
            echo "Error: Downloaded file is not valid JSON"
            head -20 public-openapi.json
            exit 1
          fi

          # Extract API version from spec
          API_VERSION=$(jq -r '.info.version // "unknown"' public-openapi.json)
          echo "api_version=$API_VERSION" >> $GITHUB_OUTPUT

          # Show summary
          ENDPOINT_COUNT=$(jq '[.paths | to_entries[] | .value | keys | length] | add // 0' public-openapi.json)
          SCHEMA_COUNT=$(jq '.components.schemas | keys | length // 0' public-openapi.json)

          echo "OpenAPI spec fetched successfully:"
          echo "  - API version: $API_VERSION"
          echo "  - Endpoints: $ENDPOINT_COUNT"
          echo "  - Schemas: $SCHEMA_COUNT"

      - name: Install dependencies
        run: pnpm install

      - name: Generate SDK from OpenAPI spec
        run: pnpm run generate

      - name: Build SDK
        run: pnpm run build:only

      - name: Run tests
        run: pnpm run test

      - name: Bump SDK version and update apiVersion
        id: version
        run: |
          # Get current SDK version
          CURRENT_VERSION=$(jq -r '.version' package.json)
          CURRENT_API_VERSION=$(jq -r '.apiVersion // "unknown"' package.json)
          API_VERSION="${{ steps.fetch_spec.outputs.api_version }}"

          echo "Current SDK version: $CURRENT_VERSION"
          echo "Current API version: $CURRENT_API_VERSION"
          echo "New API version: $API_VERSION"

          # Bump SDK version
          BUMP_TYPE="${{ steps.params.outputs.bump }}"
          NEW_VERSION=$(pnpm version $BUMP_TYPE --no-git-tag-version | tr -d 'v')

          echo "New SDK version: $NEW_VERSION"
          echo "sdk_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Update apiVersion field in package.json
          jq --arg apiVersion "$API_VERSION" '.apiVersion = $apiVersion' package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "Updated apiVersion to: $API_VERSION"

      - name: Create branch and commit
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          SDK_VERSION="${{ steps.version.outputs.sdk_version }}"
          API_VERSION="${{ steps.fetch_spec.outputs.api_version }}"
          BRANCH_NAME="sdk-update-v${SDK_VERSION}"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Check if branch already exists remotely
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, deleting it"
            git push origin --delete "$BRANCH_NAME" || true
          fi

          git checkout -b "$BRANCH_NAME"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: update SDK to v${SDK_VERSION}

            - SDK version: ${SDK_VERSION}
            - API version: ${API_VERSION}
            - Fetched from: ${{ steps.params.outputs.api_url }}"
            
            git push origin "$BRANCH_NAME"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.commit.outputs.branch_name }}
          base: master
          title: 'chore: update SDK to v${{ steps.version.outputs.sdk_version }}'
          body: |
            ## SDK Update v${{ steps.version.outputs.sdk_version }}

            This PR was automatically generated from the Abby API.

            ### Version Info
            | | Version |
            |---|---|
            | **SDK version** | `${{ steps.version.outputs.sdk_version }}` |
            | **API version** | `${{ steps.fetch_spec.outputs.api_version }}` |

            ### Changes
            - Regenerated SDK from latest OpenAPI spec
            - Fetched from: ${{ steps.params.outputs.api_url }}

            ### After Merge
            The [Publish Release](https://github.com/abby-inc/abby-node/actions/workflows/publish-release.yml) workflow will automatically:
            - Create a git tag
            - Publish to npm
            - Create a GitHub release

            ---
            *This PR was created by the [Generate SDK workflow](https://github.com/abby-inc/abby-node/actions/workflows/generate-and-publish.yml)*
          labels: |
            automated
            sdk-update
          draft: false

      - name: No changes detected
        if: steps.commit.outputs.has_changes == 'false'
        run: |
          echo "No changes detected in generated SDK"
          echo "The API spec may not have changed since the last update"

      - name: Summary
        run: |
          echo "## SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **SDK Version** | \`${{ steps.version.outputs.sdk_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **API Version** | \`${{ steps.fetch_spec.outputs.api_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bump Type** | ${{ steps.params.outputs.bump }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Spec Source** | ${{ steps.params.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.commit.outputs.has_changes }}" = "true" ]; then
            echo "### Status: PR Created âœ“" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Branch: \`${{ steps.commit.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Next: Merge PR to trigger publish" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status: No Changes Detected" >> $GITHUB_STEP_SUMMARY
          fi
