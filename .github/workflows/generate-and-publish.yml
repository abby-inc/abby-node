# This workflow is triggered by the monorepo when a new API version is released.
# It fetches the public OpenAPI spec from the live API, generates the SDK, and creates a PR.
# Publishing happens separately via publish-release.yml after the PR is merged.

name: Generate SDK

on:
  # Triggered by repository_dispatch from the monorepo
  repository_dispatch:
    types: [update-sdk]

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.32.0)'
        required: true
        type: string
      api_url:
        description: 'URL to fetch OpenAPI spec from'
        required: false
        type: string
        default: 'https://api.app-abby.com/api-docs/public.json'

jobs:
  generate:
    name: Generate SDK and Create PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Get version and API URL from event
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            API_URL="${{ github.event.client_payload.api_url }}"
          else
            VERSION="${{ inputs.version }}"
            API_URL="${{ inputs.api_url }}"
          fi

          if [ -z "$VERSION" ]; then
            echo "Error: version is required"
            exit 1
          fi

          # Default API URL if not provided
          if [ -z "$API_URL" ]; then
            API_URL="https://api.app-abby.com/api-docs/public.json"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "branch_name=sdk-update-v$VERSION" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "API URL: $API_URL"

      - name: Fetch OpenAPI spec from API
        run: |
          echo "Fetching OpenAPI spec from ${{ steps.params.outputs.api_url }}..."

          HTTP_STATUS=$(curl -s -w "%{http_code}" -o public-openapi.json "${{ steps.params.outputs.api_url }}")

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: Failed to fetch OpenAPI spec (HTTP $HTTP_STATUS)"
            exit 1
          fi

          # Validate JSON
          if ! jq empty public-openapi.json 2>/dev/null; then
            echo "Error: Downloaded file is not valid JSON"
            head -20 public-openapi.json
            exit 1
          fi

          # Show summary
          ENDPOINT_COUNT=$(jq '[.paths | to_entries[] | .value | keys | length] | add // 0' public-openapi.json)
          SCHEMA_COUNT=$(jq '.components.schemas | keys | length // 0' public-openapi.json)
          SPEC_VERSION=$(jq -r '.info.version // "unknown"' public-openapi.json)

          echo "OpenAPI spec fetched successfully:"
          echo "  - Spec version: $SPEC_VERSION"
          echo "  - Endpoints: $ENDPOINT_COUNT"
          echo "  - Schemas: $SCHEMA_COUNT"

      - name: Install dependencies
        run: pnpm install

      - name: Generate SDK from OpenAPI spec
        run: pnpm run generate

      - name: Build SDK
        run: pnpm run build:only

      - name: Run tests
        run: pnpm run test

      - name: Update package version
        run: |
          pnpm version ${{ steps.params.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Create branch and commit
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="${{ steps.params.outputs.branch_name }}"

          # Check if branch already exists remotely
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists, deleting it"
            git push origin --delete "$BRANCH_NAME" || true
          fi

          git checkout -b "$BRANCH_NAME"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: update SDK to v${{ steps.params.outputs.version }}

            - Generated from OpenAPI spec v${{ steps.params.outputs.version }}
            - Fetched from: ${{ steps.params.outputs.api_url }}"
            
            git push origin "$BRANCH_NAME"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.params.outputs.branch_name }}
          base: master
          title: 'chore: update SDK to v${{ steps.params.outputs.version }}'
          body: |
            ## SDK Update v${{ steps.params.outputs.version }}

            This PR was automatically generated from the Abby API.

            ### Changes
            - Updated SDK from OpenAPI spec v${{ steps.params.outputs.version }}
            - Fetched from: ${{ steps.params.outputs.api_url }}

            ### After Merge
            The [Publish Release](https://github.com/abby-inc/abby-node/actions/workflows/publish-release.yml) workflow will automatically:
            - Create a git tag
            - Publish to npm
            - Create a GitHub release

            ---
            *This PR was created by the [Generate SDK workflow](https://github.com/abby-inc/abby-node/actions/workflows/generate-and-publish.yml)*
          labels: |
            automated
            sdk-update
          draft: false

      - name: No changes detected
        if: steps.commit.outputs.has_changes == 'false'
        run: |
          echo "No changes detected in generated SDK"
          echo "The API spec may not have changed since the last update"

      - name: Summary
        run: |
          echo "## SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.params.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Spec Source:** ${{ steps.params.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.commit.outputs.has_changes }}" = "true" ]; then
            echo "- **Status:** PR created âœ“" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** ${{ steps.params.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Next:** Merge PR to trigger publish" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
