# This workflow publishes a new release to npm after an SDK update PR is merged.
# It can be triggered automatically when PRs with the 'sdk-update' label are merged,
# or manually for any release.

name: Publish Release

on:
  # Trigger when SDK update PRs are merged
  pull_request:
    types: [closed]
    branches: [master]

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not publish to npm)'
        required: false
        type: boolean
        default: false

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed) and has sdk-update label, or manual trigger
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'sdk-update'))

    # Required for npm Trusted Publishing (OIDC)
    environment: npm

    permissions:
      contents: write
      id-token: write # Required for npm provenance/OIDC

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          API_VERSION=$(node -p "require('./package.json').apiVersion || 'unknown'")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "api_version=$API_VERSION" >> $GITHUB_OUTPUT
          echo "SDK version: $VERSION"
          echo "API version: $API_VERSION"

      - name: Check if version already published
        id: check_published
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if this version already exists on npm
          if npm view "@abby-inc/abby-node@$VERSION" version 2>/dev/null; then
            echo "Version $VERSION is already published to npm"
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION is not yet published"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check_published.outputs.already_published == 'false'
        run: pnpm install

      - name: Build
        if: steps.check_published.outputs.already_published == 'false'
        run: pnpm run build:only

      - name: Run tests
        if: steps.check_published.outputs.already_published == 'false'
        run: pnpm run test

      - name: Create git tag
        if: steps.check_published.outputs.already_published == 'false' && github.event.inputs.dry_run != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "v$VERSION" -m "Release v$VERSION"
            git push origin "v$VERSION"
          fi

      - name: Publish to npm (dry run)
        if: steps.check_published.outputs.already_published == 'false' && github.event.inputs.dry_run == 'true'
        run: pnpm publish --dry-run --no-git-checks

      - name: Publish to npm
        if: steps.check_published.outputs.already_published == 'false' && github.event.inputs.dry_run != 'true'
        run: pnpm publish --access public --no-git-checks --provenance

      - name: Create GitHub Release
        if: steps.check_published.outputs.already_published == 'false' && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## Abby Node.js SDK v${{ steps.version.outputs.version }}

            This release is automatically generated from the Abby API.

            | | Version |
            |---|---|
            | SDK | `${{ steps.version.outputs.version }}` |
            | API | `${{ steps.version.outputs.api_version }}` |

            ### Installation
            ```bash
            npm install @abby-inc/abby-node@${{ steps.version.outputs.version }}
            ```

            ### Documentation
            - [SDK Documentation](https://github.com/abby-inc/abby-node#readme)
            - [Abby Help Center](https://aide.abby.fr)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          API_VERSION="${{ steps.version.outputs.api_version }}"
          echo "## Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **SDK Version** | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **API Version** | \`$API_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_published.outputs.already_published }}" = "true" ]; then
            echo "**Status:** Already published (skipped)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "**Status:** Dry run (not published)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Published to npm âœ“" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **npm:** https://www.npmjs.com/package/@abby-inc/abby-node/v/$VERSION" >> $GITHUB_STEP_SUMMARY
          fi
